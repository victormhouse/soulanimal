<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>灵魂栖息地 | 动物塑性格测试</title>
    
    <!-- 预加载关键资源 -->
    <link rel="preload" href="quiz_data_advanced.js" as="script">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    
    <!-- CDN资源添加备用方案 -->
    <script>
        // Tailwind CSS加载检测
        window.tailwindLoaded = false;
        setTimeout(() => {
            if (!window.tailwindLoaded) {
                document.body.innerHTML = '<div style="padding:20px;text-align:center;color:red;">样式加载超时，请检查网络或刷新重试</div>';
            }
        }, 8000);
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>window.tailwindLoaded = true;</script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="quiz_data_advanced.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f4f7f2;
            color: #2c3e50;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* ...原有样式... */
        
        /* 加载失败提示 */
        .error-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ef4444;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- 错误提示 -->
    <div id="error-toast" class="error-toast"></div>

    <!-- 1. 首页 -->
    <div id="page-landing" class="page-container w-full max-w-md bg-white rounded-3xl p-8 card-shadow text-center fade-in flex flex-col justify-center">
        <!-- 内容保持不变 -->
        <div class="mb-6">
            <span class="inline-block px-3 py-1 bg-green-100 text-green-800 text-xs rounded-full tracking-widest mb-4">SOUL HABITAT</span>
            <h1 class="text-4xl font-bold serif text-green-900 mb-2">灵魂栖息地</h1>
            <p class="text-gray-500 text-sm">动物塑性格心理测试</p>
        </div>
        
        <div class="my-8 relative">
            <div class="absolute inset-0 flex items-center justify-center opacity-10">
                <svg class="w-48 h-48" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm0-2a6 6 0 100-12 6 6 0 000 12z" clip-rule="evenodd"/></svg>
            </div>
            <p class="serif text-lg leading-relaxed text-gray-700 italic relative z-10">
                "每个人心中都住着一只野兽。<br>
                它在孤独时苏醒，在喧嚣中沉睡。<br>
                穿越这片迷雾森林，<br>
                去见那个未曾谋面的自己。"
            </p>
        </div>

        <div class="space-y-4 mt-auto">
            <button onclick="startQuiz()" class="w-full bg-green-800 text-white py-4 rounded-xl font-medium hover:bg-green-900 transition shadow-lg flex items-center justify-center gap-2 group">
                <span>开始旅程 (20题)</span>
                <svg class="w-4 h-4 group-hover:translate-x-1 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>
            </button>
            <button onclick="showPokedex()" class="w-full bg-white border border-gray-200 text-gray-600 py-3 rounded-xl font-medium hover:bg-gray-50 transition">
                查看动物图鉴
            </button>
        </div>
        <p class="mt-6 text-xs text-gray-400">已有 24,592 人找到了自己的灵魂动物</p>
    </div>

    <!-- 其他页面保持原有结构... -->

    <script>
        // --- 增强：资源加载错误检测 ---
        window.addEventListener('error', function(e) {
            if (e.target.src && e.target.src.includes('quiz_data_advanced.js')) {
                showError('题库加载失败，请刷新页面');
            }
        }, true);

        function showError(msg) {
            const toast = document.getElementById('error-toast');
            toast.textContent = msg;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 5000);
        }

        // --- 原有逻辑代码 ---
        const animals = { /* ... */ };
        
        let currentQuestionIndex = 0;
        let scores = { E:0, I:0, S:0, N:0, T:0, F:0, J:0, P:0 };
        let historyStack = [];

        // 页面切换工具
        function showPage(pageId) {
            document.querySelectorAll('body > div').forEach(div => {
                if(div.id.startsWith('page-')) div.classList.add('hidden');
                if(div.id === 'page-pokedex') div.classList.add('hidden');
            });
            const target = document.getElementById(pageId);
            target.classList.remove('hidden');
            if (pageId !== 'page-pokedex') target.classList.add('flex');
            window.scrollTo(0,0);
        }

        function startQuiz() {
            // 增强：检测题库是否加载
            if (typeof questions === 'undefined') {
                showError('题目数据未加载，请检查网络或刷新页面');
                return;
            }
            currentQuestionIndex = 0;
            scores = { E:0, I:0, S:0, N:0, T:0, F:0, J:0, P:0 };
            historyStack = [];
            showPage('page-quiz');
            renderQuestion();
        }

        // ...其余函数保持不变...
        
        // 题目渲染函数（保持原有逻辑）
        function renderQuestion() {
            const q = questions[currentQuestionIndex];
            
            // 更新进度条
            const progress = ((currentQuestionIndex) / questions.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('quiz-progress-text').innerText = `第 ${currentQuestionIndex + 1}/${questions.length} 题`;

            // 更新文本
            document.getElementById('question-text').innerText = q.q;

            // 更新选项
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            
            q.options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = "option-btn w-full text-left p-4 rounded-xl border border-gray-200 hover:border-green-600 hover:bg-green-50 transition duration-200 text-gray-700 text-sm font-medium leading-relaxed";
                btn.innerText = opt.t;
                btn.onclick = () => handleAnswer(opt.s);
                
                // 简单的入场动画
                btn.style.opacity = '0';
                btn.style.transform = 'translateY(10px)';
                setTimeout(() => {
                    btn.style.transition = 'all 0.4s ease';
                    btn.style.opacity = '1';
                    btn.style.transform = 'translateY(0)';
                }, index * 100);

                container.appendChild(btn);
            });

            // 底部控制栏显示逻辑
            const controls = document.getElementById('quiz-controls');
            if(currentQuestionIndex > 0) {
                controls.classList.remove('opacity-0');
            } else {
                controls.classList.add('opacity-0');
            }
        }

        function handleAnswer(scoreDelta) {
            // 记录历史（深拷贝）
            historyStack.push({ ...scores });

            // 加分
            for (let key in scoreDelta) {
                if (scores.hasOwnProperty(key)) {
                    scores[key] += scoreDelta[key];
                }
            }

            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            } else {
                finishQuiz();
            }
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0 && historyStack.length > 0) {
                // 恢复分数
                scores = historyStack.pop();
                currentQuestionIndex--;
                renderQuestion();
            }
        }

        function backToHome() {
            if(confirm("确定要退出吗？当前进度将丢失。")) {
                showPage('page-landing');
            }
        }

        function finishQuiz() {
            showPage('page-loading');
            
            const loadingTexts = ["整合思维碎片...", "分析社交磁场...", "匹配灵魂原型...", "生成最终报告..."];
            let step = 0;
            const interval = setInterval(() => {
                if (step < loadingTexts.length) {
                    document.getElementById('loading-text').innerText = loadingTexts[step];
                    step++;
                }
            }, 600);

            setTimeout(() => {
                clearInterval(interval);
                calculateResult();
            }, 2500);
        }

        function calculateResult() {
            const dim1 = scores.E >= scores.I ? 'E' : 'I';
            const dim2 = scores.S >= scores.N ? 'S' : 'N';
            const dim3 = scores.T >= scores.F ? 'T' : 'F';
            const dim4 = scores.J >= scores.P ? 'J' : 'P';

            let animalKey = "capybara";
            if (dim2 === 'N' && dim3 === 'F') {
                if (dim1 === 'E') animalKey = dim4 === 'P' ? "dolphin" : "golden_retriever";
                else animalKey = "deer";
            } else if (dim2 === 'N' && dim3 === 'T') {
                if (dim1 === 'I') animalKey = dim4 === 'J' ? "owl" : "snow_leopard";
                else animalKey = "wolf";
            } else if (dim2 === 'S' && dim4 === 'J') {
                if (dim3 === 'T') animalKey = "wolf";
                else animalKey = "golden_retriever";
            } else if (dim2 === 'S' && dim4 === 'P') {
                if (dim3 === 'T') animalKey = "honey_badger";
                else animalKey = "capybara";
            }

            renderResultPage(animalKey);
            showPage('page-result');
        }

        function renderResultPage(key) {
            const data = animals[key];
            
            document.getElementById('result-animal').innerText = data.name;
            document.getElementById('result-slogan').innerText = data.slogan;
            document.getElementById('result-desc').innerText = data.desc;
            document.getElementById('result-match').innerText = animals[data.match] ? animals[data.match].name : data.match;
            document.getElementById('result-enemy').innerText = animals[data.enemy] ? animals[data.enemy].name : data.enemy;

            const header = document.getElementById('result-header');
            header.className = `p-6 text-white relative overflow-hidden bg-gradient-to-br ${data.color}`;

            const tagsContainer = document.getElementById('result-tags');
            tagsContainer.innerHTML = data.tags.map(t => `<span class="px-2 py-1 bg-white/20 rounded text-xs tag-chip">${t}</span>`).join('');

            renderRadarChart();
        }

        let radarChartInstance = null;
        function renderRadarChart() {
            const ctx = document.getElementById('radarChart').getContext('2d');
            
            const normalize = (val) => Math.min((val / 10) * 100, 100);

            const dataValues = [
                normalize(scores.E),
                normalize(scores.F),
                normalize(scores.N),
                normalize(scores.T),
                normalize(scores.J)
            ];

            if (radarChartInstance) radarChartInstance.destroy();

            radarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['社交', '共情', '想象', '逻辑', '执行'],
                    datasets: [{
                        label: '能力维度',
                        data: dataValues,
                        backgroundColor: 'rgba(22, 101, 52, 0.2)',
                        borderColor: 'rgba(22, 101, 52, 1)',
                        pointBackgroundColor: 'rgba(22, 101, 52, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(22, 101, 52, 1)'
                    }]
                },
                options: {
                    scales: {
                        r: {
                            angleLines: { color: '#e5e7eb' },
                            grid: { color: '#e5e7eb' },
                            pointLabels: {
                                font: { size: 11, family: "'Noto Sans SC', sans-serif" },
                                color: '#6b7280'
                            },
                            suggestedMin: 0,
                            suggestedMax: 100,
                            ticks: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    },
                    maintainAspectRatio: false
                }
            });
        }

        function showPokedex() {
            const grid = document.getElementById('pokedex-grid');
            grid.innerHTML = '';
            
            Object.keys(animals).forEach(key => {
                const a = animals[key];
                const card = document.createElement('div');
                card.className = "bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex gap-4 items-center hover:shadow-md transition";
                card.innerHTML = `
                    <div class="w-16 h-16 rounded-full bg-gradient-to-br ${a.color} flex items-center justify-center text-white text-xl font-bold serif shrink-0">
                        ${a.name[0]}
                    </div>
                    <div class="flex-1">
                        <h4 class="font-bold text-gray-800">${a.name}</h4>
                        <p class="text-xs text-gray-500 mb-1">${a.slogan}</p>
                        <div class="flex gap-1 flex-wrap">
                             ${a.tags.slice(0,2).map(t => `<span class="text-[10px] bg-gray-100 text-gray-500 px-1 rounded">${t}</span>`).join('')}
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });

            document.getElementById('page-pokedex').classList.remove('hidden');
        }

        function closePokedex() {
            document.getElementById('page-pokedex').classList.add('hidden');
        }

    </script>
</body>
</html>
